CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 3 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (201826,4193704,443732,201254,435216,443412)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (201826,4193704,443732,201254,435216,443412)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4058243)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4058243)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 4 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (21600744)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (21600744)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 5 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (2212392,40762352,3005673,3003309,3007263,3004410,3034639,4197971,40758583,44786901)

) I
) C UNION ALL 
SELECT 7 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (262,9201)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (262,9201)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 8 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (1201620,1154029,1174888,1126658,1102527,1103640,1110410,1124957,1103314)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (1201620,1154029,1174888,1126658,1102527,1103640,1110410,1124957,1103314)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 9 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (2001516,4336541,4144721,2104834,2103634,2778049,2778051,2778050,2778052,4219321,2103556,2103557,2103558,4233085,2105065,2001509,4008625,4106548,4031996,4234990,4198190,2109141,2109143,2109142,2103572,2103500,2103513,2103512,2103501,40756843,40756885,2103499,2103535,2103536,2103537,42742495,42742494,2103497,2103496,2103498,2103521,2103520,2103516,2103519,2103518,2103517,2103515,2103514,2103534,2103533,2103532,2101816,2101805,43527910,43528040,2104236,2105089,2105090,2104238,2105103,2105102,2105091,2105087,2105088,2105086,2105085,2105996,2105995,2105998,2105997,2105957,2106886,2106885,43021873,4073526,4182056,4297990,4297155,4143193,4293893,4107080,2110268,2110269,2110270,4329559,4245519,2109373,2109355,2725356,2725388,2725350,2725382,2725368,2725401,2725362,2725395,42894402,42894408,2725374,2725407,2725357,2725389,2725351,2725383,2725369,2725402,2725363,2725396,42894403,42894409,2725352,2725384,2725346,2725378,2725364,2725397,2725358,2725391,42894398,42894404,2725370,2725403,2725375,2725377,2725376,2725390,2725354,2725386,2725348,2725380,2725366,2725399,2725360,2725393,42894400,42894406,2725372,2725405,2725353,2725385,2725347,2725379,2725365,2725398,2725359,2725392,42894399,42894405,2725371,2725404,2725355,2725387,2725349,2725381,2725367,2725400,2725361,2725394,42894401,42894407,2725373,2725406,2724724,2724756,2724718,2724750,2724736,2725215,2724730,2724763,42894245,42894251,2724742,2725221,2724725,2724757,2724719,2724751,2724737,2725216,2724731,2724764,42894246,42894252,2724720,2724752,2724714,2724746,2724732,2724765,2724726,2724759,42894241,42894247,2724738,2725217,2724743,2724745,2724744,2724758,2724722,2724754,2724716,2724748,2724734,2725213,2724728,2724761,42894243,42894249,2724740,2725219,2724721,2724753,2724715,2724747,2724733,2724766,2724727,2724760,42894242,42894248,2724739,2725218,2724723,2724755,2724717,2724749,2724735,2725214,2724729,2724762,42894244,42894250,2724741,2725220,2725294,2725326,2725288,2725320,2725306,2725339,2725300,2725333,42894233,42894239,2725312,2725345,2725295,2725327,2725289,2725321,2725307,2725340,2725301,2725334,42894234,42894240,2725290,2725322,2725284,2725316,2725302,2725335,2725296,2725329,42894229,42894235,2725308,2725341,2725313,2725315,2725314,2725328,2725292,2725324,2725286,2725318,2725304,2725337,2725298,2725331,42894231,42894237,2725310,2725343,2725291,2725323,2725285,2725317,2725303,2725336,2725297,2725330,42894230,42894236,2725309,2725342,2725293,2725325,2725287,2725319,2725305,2725338,2725299,2725332,42894232,42894238,2725311,2725344,2725232,2725264,2725226,2725258,2725244,2725277,2725238,2725271,42894257,42894227,2725250,2725283,2725233,2725265,2725227,2725259,2725245,2725278,2725239,2725272,42894258,42894228,2725228,2725260,2725222,2725254,2725240,2725273,2725234,2725267,42894253,42894223,2725246,2725279,2725251,2725253,2725252,2725266,2725230,2725262,2725224,2725256,2725242,2725275,2725236,2725269,42894255,42894225,2725248,2725281,2725229,2725261,2725223,2725255,2725241,2725274,2725235,2725268,42894254,42894224,2725247,2725280,2725231,2725263,2725225,2725257,2725243,2725276,2725237,2725270,42894256,42894226,2725249,2725282,2778518,2778520,2778523,2778522,2778521,2778528,2778519,1531652,2778505,2778512,2778507,2778510,2778509,2778508,2778506,1531660,2741578,2741579,2741577,4231998,2104133,2104134,2109368,4242997,2109370,2109371,2109372,2109369,2109345,2109344,2103632,2103633,4280680,4060561,4104645,4159841,4051625,4167090,4195117,2005415,2005418,2005412,2005417,2005416,4175346,2005498,2104897,2104896,2105430,2105429,2105404,2105403,2105688,2105687,2105169,2105168,2105391,2105390,2104279,2104278,2105164,2105162,2104942,2104941,2104912,2104901,2105148,2105146,2105736,2105735,2105411,2105410,2105740,2105739,2104919,2104932,2104921,2105187,2105781,2105780,2104916,2104915,2105190,2105189,2105382,2105371,2105732,2105721,2105777,2105776,2105205,2105204,2105171,2104940,2104939,2105385,2105384,2105388,2105387,2105427,2105426,2104274,2104255,2105752,2105149,2105147,2105759,2105758,2105713,2105712,2105755,2105754,2105773,2105772,2105184,2105183,2105367,2105366,2105407,2105406,2104261,2106865,2109758,2109056,2109047,2109041,2109045,2109046,2109043,2109044,2109042,2109053,2109055,2109054,2109052,2109049,2109048,42736543,42736542,2003246,2103056,2778816,2779014,2779020,2779052,2779011,2107242,2107243,2107244,2107231,2107223,2107224,2107226,2107227,2107228,2107222,2107217,2107218,2107219,2107220,2107221,2107216,2103058,2103360,2110660,2110659,2110433,2110741,4216651,4016929,2005535,2005534,2110616,2106731,4074687,2106728,2106727,2742069,2741605,2768495,2768496,2768497,2768501,2768502,2768503,2742083,2741834,2742054,2742064,2741819,2742077,2741824,2741854,2741829,2773510,2773511,2773512,2773516,2773517,2773518,2741859,2742080,2741814,2741849,2742059,2741799,2741809,2741844,2742074,2741804,2741839,2768507,2768508,2768509,2768513,2768514,2768515,2741600,2742097,2742098,2742370,2742371,2742340,2742341,2742350,2742351,2742360,2742361,2742330,2742331,2742107,2742108,2742320,2742321,2742310,2742311,2742087,2742088,4145274,2110662,2110661,2110664,2110663,2103379,2106870,4337612,2743623,2743625,2743624,2742590,2742592,2742591,2779329,2779518,2779521,2779517,2779516,2779520,2779523,2743860,2743862,2743861,2743109,2743111,2743110,2743391,2743393,2743392,2743608,2743610,2743609,2742863,2742865,2742864,2743647,2743650,2743653,2743649,2743648,2743655,2779533,2779536,2779539,2779535,2779534,2779541,2742878,2742880,2742879,2743361,2743363,2743362,2743094,2743096,2743095,2743376,2743378,2743377,2743656,2743658,2743657,2742848,2742850,2742849,2743154,2743348,2743347,2743406,2743408,2743407,2742605,2742607,2742606,2742833,2742835,2742834,2743139,2743141,2743140,2743638,2743641,2743644,2743640,2743639,2743646,2779524,2779527,2779530,2779526,2779525,2779532,2742620,2742622,2742621,2743124,2743126,2743125,2742575,2742577,2742576,2003002,42627898,2001522,2109017,2104876,40757012,2104136,2103361,2103372,2763265,2763267,2763269,2763271,2763273,2763275,2744438,2744437,2743881,2743880,2763277,2763279,2763281,2766009,2766011,2766013,2766021,2766023,2766025,2780048,2780047,2762965,2762967,2762969,2759847,2759849,2759851,2750676,2750678,2750680,2760377,2760570,2760572,2763423,2763425,2763427,2766505,2766507,2766509,2763764,2763766,2763768,2766517,2766519,2766521,2763512,2763514,2763516,2744659,2744658,2760107,2760109,2760111,2763447,2763449,2763451,2762923,2762925,2762927,2766541,2766543,2766545,2763987,2763989,2763991,2759853,2759855,2759857,2763500,2763502,2763504,2758279,2758281,2758283,2763524,2763526,2763528,2763536,2763538,2763540,2760119,2760121,2760315,2763459,2763461,2763463,2744157,2744156,2744408,2744407,2744428,2744427,2744430,2744434,2744127,2744126,2760371,2760373,2760375,2760359,2760361,2760363,2763776,2763778,2763780,2766529,2766531,2766533,2762947,2762949,2762951,2760077,2760079,2760081,2760347,2760349,2760351,2760323,2760325,2760327,2759865,2759867,2759869,2763471,2763473,2763475,2762715,2762717,2762719,2744647,2744646,2763740,2763742,2763744,2763488,2763490,2763492,2760095,2760097,2760099,2762935,2762937,2762939,2760065,2760067,2760069,2763788,2763790,2763792,2762911,2762913,2762915,2762959,2762961,2762963,2763752,2763754,2763756,2763435,2763437,2763439,2744137,2744136,2744388,2744387,2760335,2760337,2760339,2744147,2744146,2762697,2762699,2762701,2770592,2770594,2770596,2770604,2770606,2770608,2744398,2744397,2760353,2760355,2760357,2760083,2760085,2760087,2760071,2760073,2760075,2763417,2763419,2763421,2766311,2766313,2766315,2763758,2763760,2763762,2766511,2766513,2766515,2763506,2763508,2763510,2744653,2744652,2760101,2760103,2760105,2763441,2763443,2763445,2762917,2762919,2762921,2766535,2766537,2766539,2763794,2763796,2763798,2763494,2763496,2763498,2758273,2758275,2758277,2763518,2763520,2763522,2763530,2763532,2763534,2760113,2760115,2760117,2763453,2763455,2763457,2743921,2743920,2744378,2744377,2744418,2744417,2744420,2744424,2743891,2743890,2760365,2760367,2760369,2763770,2763772,2763774,2766523,2766525,2766527,2762941,2762943,2762945,2743911,2743910,2744177,2744176,2760341,2760343,2760345,2760317,2760319,2760321,2759859,2759861,2759863,2763465,2763467,2763469,2762709,2762711,2762713,2744641,2744640,2763542,2763736,2763738,2763482,2763484,2763486,2762929,2762931,2762933,2760059,2760061,2760063,2763782,2763784,2763786,2763477,2763479,2762909,2762953,2762955,2762957,2763746,2763748,2763750,2763429,2763431,2763433,2743901,2743900,2744167,2744166,2760329,2760331,2760333,2762703,2762705,2762707,2759841,2759843,2759845,2760089,2760091,2760093,2763259,2763261,2763263,2763283,2763285,2763287,2766033,2766035,2766037,2766045,2766047,2766049,2743871,2743870,42732422,2103038,2103053,2103052,2103034,2103055,2103054,2103032,2103021,2104780,2104779,2104781,4236352,2005138,2005120,4286804,4169230,709956,2102700,709958,709957,2102712,2102701,2102834,4062241,2109164,2103040,2103041,2103037,2103036,4174349,2109163,2109162,2109166,40756915,40756981,2103359,4070880,2103035,2104116,2104118,2104117,2103635,2103637,2103636,2105007,2105008,2105009,2105010,2103844,2103846,2103845,2104435,2104436,2103638,2103640,2103639,2104437,2104438,2104113,2104115,2104114,2103831,2103843,2103842,2105531,2105525,2105528,2105265,2105267,2105266,2005708,2102520,2102519,2102541,2102538,2102540,2103847,2102536,2102532,2102534,2102557,2102553,2102555,4197068,4096152,2744948,2744670,2745150,2744903,2744933,2744943,2744695,2745144,2780316,2780317,2780318,2744893,2744923,2744898,2744928,2745147,2744690,2744918,2744938,2744675,2744685,2744913,2745141,2780312,2780313,2780314,2744680,2744908,2744665,43017451,43017472,43017460,43017462,43017471,43017468,43017464,43017453,2745161,2745160,2745163,2745162,43017455,43017466,43017469,43017457,43017456,43017459,43017461,43017470,43017467,43017463,43017452,2745155,2745154,2745157,2745156,43017454,43017465,43017450,43017458,2106785,42735676,4124309,2745173,2745410,2745392,2780562,2745398,2745404,2745197,2745179,2745191,2780558,2745185,2745167,42898036,43018373,2767299,2767314,2767329,2767301,2767316,2767522,2767300,2767315,2767330,2767302,2767317,2767523,2767304,2767319,2767525,2767303,2767318,2767524,2767308,2767323,2767529,2767310,2767325,2767531,2767309,2767324,2767530,2767305,2767320,2767526,2767307,2767322,2767528,2767306,2767321,2767527,2767311,2767326,2767532,2767313,2767328,2767534,2767312,2767327,2767533,42898043,43018380,2771586,2771601,2771616,2771588,2771603,2771801,2771587,2771602,2771800,2771589,2771604,2771802,2771591,2771606,2771804,2771590,2771605,2771803,2771595,2771610,2771808,2771597,2771612,2771810,2771596,2771611,2771809,2771592,2771607,2771805,2771594,2771609,2771807,2771593,2771608,2771806,2771598,2771613,2771811,2771600,2771615,2771813,2771599,2771614,2771812,42898039,43018376,2767814,2767829,2768032,2767816,2767831,2768034,2767815,2767830,2768033,2767817,2767832,2768035,2767819,2767834,2768037,2767818,2767833,2768036,2767823,2768026,2768041,2767825,2768028,2768043,2767824,2768027,2768042,2767820,2767835,2768038,2767822,2767837,2768040,2767821,2767836,2768039,2767826,2768029,2768044,2767828,2768031,2768046,2767827,2768030,2768045,42898040,43018377,2768047,2768062,2768077,2768049,2768064,2768079,2768048,2768063,2768078,2768050,2768065,2768080,2768052,2768067,2768082,2768051,2768066,2768081,2768056,2768071,2768086,2768058,2768073,2768088,2768057,2768072,2768087,2768053,2768068,2768083,2768055,2768070,2768085,2768054,2768069,2768084,2768059,2768074,2768089,2768061,2768076,2768281,2768060,2768075,2768280,42898035,43018372,2767059,2767269,2767284,2767061,2767271,2767286,2767060,2767270,2767285,2767062,2767272,2767287,2767064,2767274,2767289,2767063,2767273,2767288,2767068,2767278,2767293,2767070,2767280,2767295,2767069,2767279,2767294,2767065,2767275,2767290,2767067,2767277,2767292,2767066,2767276,2767291,2767071,2767281,2767296,2767268,2767283,2767298,2767267,2767282,2767297,42898037,43018374,2767535,2767550,2767565,2767537,2767552,2767567,2767536,2767551,2767566,2767538,2767553,2767568,2767540,2767555,2767570,2767539,2767554,2767569,2767544,2767559,2767574,2767546,2767561,2767576,2767545,2767560,2767575,2767541,2767556,2767571,2767543,2767558,2767573,2767542,2767557,2767572,2767547,2767562,2767577,2767549,2767564,2767579,2767548,2767563,2767578,2772064,2772069,2772074,2772063,2772068,2772073,2772066,2772071,2772076,2772065,2772070,2772075,2772067,2772072,2772077,2772094,2772099,2772104,2772093,2772098,2772103,2772096,2772101,2772106,2772095,2772100,2772105,2772097,2772102,2772107,42898042,43018379,2771351,2771556,2771571,2771353,2771558,2771573,2771352,2771557,2771572,2771354,2771559,2771574,2771356,2771561,2771576,2771355,2771560,2771575,2771360,2771565,2771580,2771362,2771567,2771582,2771361,2771566,2771581,2771357,2771562,2771577,2771359,2771564,2771579,2771358,2771563,2771578,2771553,2771568,2771583,2771555,2771570,2771585,2771554,2771569,2771584,42898044,43018381,2771814,2771829,2771844,2771816,2771831,2771846,2771815,2771830,2771845,2771817,2771832,2771847,2771819,2771834,2771849,2771818,2771833,2771848,2771823,2771838,2771853,2771825,2771840,2771855,2771824,2771839,2771854,2771820,2771835,2771850,2771822,2771837,2771852,2771821,2771836,2771851,2771826,2771841,2771856,2771828,2771843,2771858,2771827,2771842,2771857,42898034,43018371,2767014,2767029,2767044,2767016,2767031,2767046,2767015,2767030,2767045,2767017,2767032,2767047,2767019,2767034,2767049,2767018,2767033,2767048,2767023,2767038,2767053,2767025,2767040,2767055,2767024,2767039,2767054,2767020,2767035,2767050,2767022,2767037,2767052,2767021,2767036,2767051,2767026,2767041,2767056,2767028,2767043,2767058,2767027,2767042,2767057,2772079,2772084,2772089,2772078,2772083,2772088,2772081,2772086,2772091,2772080,2772085,2772090,2772082,2772087,2772092,2771860,2772054,2772059,2771859,2772053,2772058,2772051,2772056,2772061,2771861,2772055,2772060,2772052,2772057,2772062,42898038,43018375,2767580,2767784,2767799,2767582,2767786,2767801,2767581,2767785,2767800,2767583,2767787,2767802,2767774,2767789,2767804,2767584,2767788,2767803,2767778,2767793,2767808,2767780,2767795,2767810,2767779,2767794,2767809,2767775,2767790,2767805,2767777,2767792,2767807,2767776,2767791,2767806,2767781,2767796,2767811,2767783,2767798,2767813,2767782,2767797,2767812,42898041,43018378,2768282,2768297,2768312,2768284,2768299,2768314,2768283,2768298,2768313,2768285,2768300,2768315,2768287,2768302,2768317,2768286,2768301,2768316,2768291,2768306,2768321,2768293,2768308,2768323,2768292,2768307,2768322,2768288,2768303,2768318,2768290,2768305,2768320,2768289,2768304,2768319,2768294,2768309,2768324,2768296,2768311,2768326,2768295,2768310,2768325,40492497,40492498,2005911,2005922,2005923,36674526,36674525,36674524,2107922,36674527,2001518,2105568,2109343,4127886,2722223,2109503,2110626,4220986,2103353,46270982,43021556,2003248,2741868,2741862,2741635,2741620,2741625,2741630,2741615,2745448,2741610,2745453,2763205,2763207,2763209,2763975,2763982,2768345,2768845,2768852,2768859,2768373,2768380,2768387,2768884,2768886,2768888,2768400,2768402,2768404,2768872,2768874,2768876,2768616,2768623,2768630,2768896,2768898,2768900,2763933,2763940,2763947,2763199,2763201,2763203,2763954,2763961,2763968,2768637,2768644,2768651,2768352,2768359,2768366,2768878,2768880,2768882,2768394,2768396,2768398,2768866,2768868,2768870,2768595,2768602,2768609,2768890,2768892,2768894,2763211,2763218,2763926,2763980,2768343,2768350,2768850,2768857,2768864,2768378,2768385,2768392,2768621,2768628,2768635,2763938,2763945,2763952,2763959,2763966,2763973,2768642,2768649,2768843,2768357,2768364,2768371,2768600,2768607,2768614,2763216,2763223,2763931,2781047,2741657,2781065,2741642,2781056,2745419,2763974,2763981,2768344,2768844,2768851,2768858,2768372,2768379,2768386,2768883,2768885,2768887,2768399,2768401,2768403,2768871,2768873,2768875,2768615,2768622,2768629,2768895,2768897,2768899,2763932,2763939,2763946,2763953,2763960,2763967,2768636,2768643,2768650,2768351,2768358,2768365,2768877,2768879,2768881,2768393,2768395,2768397,2768865,2768867,2768869,2768594,2768601,2768608,2768889,2768891,2768893,2763210,2763217,2763925,2745438,2745420,2763976,2763983,2768346,2768846,2768853,2768860,2768374,2768381,2768388,2768617,2768624,2768631,2763934,2763941,2763948,2763955,2763962,2763969,2768638,2768645,2768652,2768353,2768360,2768367,2768596,2768603,2768610,2763212,2763219,2763927,2741867,2741656,2741861,2741641,2745437,2745418,2763978,2763985,2768348,2768848,2768855,2768862,2768376,2768383,2768390,2768619,2768626,2768633,2763936,2763943,2763950,2763957,2763964,2763971,2768640,2768647,2768654,2768355,2768362,2768369,2768598,2768605,2768612,2763214,2763221,2763929,2781048,43016822,2781066,43016802,2781057,43016781,43016776,2781046,2741655,2781064,2741640,2781055,2745417,2763979,2763986,2768349,2768849,2768856,2768863,2768377,2768384,2768391,2768620,2768627,2768634,2763937,2763944,2763951,2763958,2763965,2763972,2768641,2768648,2768655,2768356,2768363,2768370,2768599,2768606,2768613,2763215,2763222,2763930,4155182,42628053,42627929,42627866,2006321,2006334,37396360,4324047,2006359,2006357,2006354,2777808,2741904,2726370,2741892,2777815,2777818,2741898,2741886,2777812,2741880,2741874,2005312,2005301,4002375,4289593,2103552,2103539,2103538,2110679,2110680,2110691,2110692,2110693,2110730,4119231,2110688,2110689,2110684,2110685,2110686,2110687,2110678,2110677,2110635,2110637,2110638,2110636,2110640,2110642,2110641,2110676,2110639,2110681,2110682,2110683,2110650,2110653,2110652,2110651,2110690,2110654,2110655,2110646,2110648,2110649,2110647,2110643,2110644,2110645,2002984,4243973,46270989,46270988,2000804,4305185,46273707,2000811,4163971,2002911,44809616,46270663,2000810,42872496,2000809,2002969,4032735,2004251,2004266,2000791,2000802,2000803,40488381,42872508,4032622,2002768,4141244,2004242,2000790,2004245,4179797,4030387,4294805,40480864,2110044,2109144,2109074,2109521,2109520,2109523,2109522,2109519,2109518,2110209,2110210,2110211,2110212,725065,2110215,2110229,2110230,2110231,2110232,2110216,2110218,2110219,2110220,2722210,2109363,2722214,2109364,2722215,2109365,2722216,2722213,2109065,2109068,2109069,2109067,2109066,2109072,2109073,2109071,42739084,2722208,2109207,2109206,2109209,2109516,2722211,2722212,2109517,2722202,2110240,2722205,2722206,4012909,46270669,2005112,2005113,2005117,2005114,2005099,2005116,4119268,4212499,4238976,2004870,4312605,2005818,2005817,2106884,2106883,2106882,2106871,4164907,2106868,2102736,2102735,2102734,2102732,2106388,2106387,2899765,2800951,2831655,2886185,2899766,2806349,2831795,2868041,2891096,2831804,2880841,2841930,2818500,2806494,2846480,2846492,2894019,2859750,2841941,2806509,2856839,2818516,2831812,2841940,2854195,2818527,2839478,2868064,2880991,2886368,2894050,2873254,2868070,2886377,2831989,2859925,2806657,2831990,2894181,2881138,2859929,2859928,2868212,2900105,2859926,2826598,2839642,2826619,2894198,2860076,2846816,2881154,2826744,2826745,2839652,2832155,2806825,2894352,2801291,2839667,2832165,2806827,2806826,2873436,2832168,2826768,2881177,2806829,2881176,2818845,2873439,2826765,2818708,2826766,2868386,2886567,2839824,2806854,2839840,2886888,2827087,2839841,2897801,2881476,2886887,2871114,2819029,2801615,2871118,2814841,2886890,2832342,2865950,2832340,2847015,2814836,2894540,2807010,2894521,2818882,2897786,2832328,2806801,2801396,2819002,2806802,2847127,2814791,2860040,2852013,2865773,2836985,2878796,2832281,1532654,2859902,2847124,2865769,1535842,1532947,1532246,43019637,2865768,2852009,1536476,2873711,2897578,2891750,1533111,1532681,1536397,43018700,2852014,2814793,2891886,2832289,2847129,2886685,2814792,2847128,2891885,2801397,2899589,2800799,2846301,2826265,2826266,2899590,2880669,2831622,2806171,2896243,2794810,2803099,2831237,2843655,2803103,2803123,2831382,2836258,2856678,2869797,2794818,2896247,2831370,2856541,2875182,2896252,2816037,2883488,2888363,2820923,2888367,2888371,2831375,2831373,2888370,2883490,2843666,2803111,2888356,2883481,2820919,2794814,2794815,2843661,2803113,2843667,2848910,2831379,2803121,2848896,2803102,2856544,2816028,2862270,2794813,2848904,2816036,2816032,2883486,2831385,2896257,2862280,2836264,2883638,2803257,2856693,2896268,2856694,2896262,2848916,2856686,2888383,2869936,2888384,2869935,2856684,2883493,2843671,2883498,2848914,2856680,2808828,2875313,2831395,2794828,2843674,2831389,2820929,2883496,2883642,2820938,2794833,2875336,2875337,2849059,2843826,2856715,2869961,2875327,2869947,2883653,2883654,2808838,2896405,2896272,2836273,2794839,2843692,2803280,2875330,2883658,2795384,2896409,2869955,2836279,2856710,2803285,2862433,2896414,2828711,2883660,2803283,2828714,2821077,2821078,2883650,2803268,2820942,2883643,2831400,2875322,2836270,2831404,2803263,2803274,2856703,2896408,2836284,2856714,2808848,2856713,2843823,2883663,2803259,2803260,2875319,2875325,2896274,2843686,2820939,2848923,2888389,2856708,2803277,2896411,2869950,2896406,2888520,2888527,2808461,2862449,2875477,2896431,2870105,2808467,2821090,2808470,2875343,2896422,2803289,2816204,2808476,2883809,2808472,2803417,2836422,2808478,2843840,2828727,2870102,2836425,2875474,2795394,2821088,2883671,2888528,2821085,2816198,2795397,2875344,2821099,2803421,2883815,2896430,2816195,2836410,2808465,2883805,2843831,2862438,2869968,2875348,2862445,2808471,2856850,2821102,2896577,2836444,2828876,2856864,2803427,2896437,2875488,2856853,2821106,2888546,2849079,2816348,2816222,2896443,2862576,2821228,2843855,2883828,2875492,2821233,2856862,2875493,2883821,2875486,2875480,2816212,2795401,2843845,2843850,2856856,2803437,2808491,2870118,2888552,2803422,2896433,2795404,2849075,2843844,2828734,2808486,2875490,2803429,2836435,2888554,2816359,2828878,2828879,2862585,2888555,2875505,2896590,2896591,2821242,2870124,2883834,2862591,2875503,2849205,2795409,2875499,2875500,2862584,2816361,2883836,2828886,2828883,2862588,2856882,2888696,2844000,2808984,2836593,2808985,2816370,2888693,2803456,2828892,2836584,2870136,2888694,2862607,2821256,1532389,2828895,2896599,2849215,2794992,1533966,2821253,2849213,2836586,2862599,2856873,2795419,2870135,2803447,2836582,2808974,1534150,2883837,2843997,2856870,2808502,1534474,2808501,2862604,2821251,2883840,2836583,2836598,2844006,2794997,2870278,2896605,2821259,2849225,2794999,2896604,2888697,2875632,2803591,2849232,2875638,2862613,2870280,2809001,2821388,2816517,2888710,2862741,2836610,2821389,2816520,2829037,2803603,2808996,2795004,2816387,2816388,2836605,2803607,2828903,2883986,2803599,2857019,2816384,2836603,2870284,2875643,2888703,2883983,2808989,2821263,2803608,2862738,2816513,2862739,2844008,2862615,2875641,2870282,2836613,2883993,2821395,2888720,2888718,2888719,2803613,2849243,2809006,2857028,2875648,2883995,2829047,2829048,2829046,2849361,2896755,2844015,2821393,2809008,2795012,2862745,2888715,2888716,2809004,2870291,2809005,2870292,2896753,2829045,2883992,2857027,2888717,2795009,2803612,2836614,2849362,2875650,2821391,2795011,2857030,2888723,2888862,2896772,2816532,2884016,2896759,2821400,2803621,2834126,2875656,2834124,2821409,2803627,2857037,2870298,2875662,2862752,2862753,2821410,2808643,2803755,2829057,2870302,2875658,2888728,2875652,2875653,2834122,2888727,2884007,2896764,2875667,2896770,2795029,2896769,2816521,2836616,2808637,2803619,2883998,2870294,2808641,2849373,2896763,2829053,2896784,2821892,2834150,2849393,2888876,2857183,1532806,2862770,2834146,2795585,2857182,2870311,1533714,2862763,2795581,2829067,2862761,2862760,1534460,2862759,2896782,2821424,2821425,1535987,2862768,2834139,2834140,2795578,2888865,2803762,2808652,2896776,2888866,2862757,2834133,2849381,2849380,2834134,2821414,2808646,2803759,2808647,1532633,2795031,2875668,2834153,2834154,2888895,2884164,2834289,2875809,2821902,2829207,2875802,2795603,2884153,2849399,2884162,2803780,2829213,2888888,2803778,2896925,2795610,2821908,2875806,2795609,2862905,2884163,2821901,2888882,2844157,2816549,2870447,2884152,2870450,2857196,2896927,2829224,2809012,2849532,2834152,2816547,2829206,2888883,2808665,2857189,2884160,2834162,2857192,2888886,2857203,2834291,2844167,2884173,2870459,2870460,2862909,2829226,2896930,2798741,2888898,2857205,2884172,2875815,2870457,2884169,2870458,2884171,2821916,2889017,2814423,2821915,2849534,2814420,2884166,2884167,2821910,2821911,2814421,2803789,2875811,2888896,2803786,2803787,2857204,2844165,2884170,2834293,2821913,2821914,2889018,2834295,2870469,2834300,2814429,2798748,2803792,2844173,2849539,2870462,2816686,2889019,2862912,2857212,2844176,2875818,2870467,2834298,2889025,2798746,2821923,2896936,2816689,2798747,2857210,2889020,2849536,2849537,2857207,2798743,2814426,2803794,2849535,2834294,2803790,2803791,2862910,2816685,2896934,2803796,2821921,2870464,2844186,2829237,2889033,2821930,2870607,2844195,2862927,2798763,2821548,2889048,2821549,2870609,2844192,2889039,2798761,2857354,2816698,2889041,2829373,2803944,2814437,2798759,2849554,2803941,2829242,2884317,2834312,2849555,2844184,2829236,2889031,2834306,2896955,2889043,2875960,2896956,2814438,2857353,2896950,2844190,2821561,2897104,2821562,2844342,2889172,2834447,1535718,2803961,2870624,2821558,2844337,2857361,1534302,2814459,2844336,2803955,2803954,1533932,2798770,2870626,2844340,1536311,2829381,2870618,2849702,2897094,2844331,2897093,2834328,2875965,2862930,2834321,2844328,2870613,2814450,2896959,2875961,2834322,2889050,1535617,2814451,2875820,2862914,2857214,2798750,2814433,2896946,2829235,2884312,2857222,2896945,2821928,2862919,2844182,2803937,2889029,2849549,2829232,2829233,2829234,2816692,2862916,2857219,2862917,2884307,2875824,2870473,2875825,2814432,2875821,2862915,2803932,2829227,2889028,2803933,2834304,2857218,2896940,2844177,2803930,2884178,2798753,2896943,2816691,2870474,2896942,2821925,2849546,2821926,2829398,2870631,2849712,2857365,2857366,2875974,2889174,2816709,2821565,2857367,2821566,2897107,2821564,2816707,2849713,2816708,2884336,2798773,2882208,2825118,2868704,2825117,2817098,2804494,2863519,2882206,2882207,2105565,2109040,2741924,2741925,2742116,2742410,2742411,2742412,2742179,2742372,2742373,2742384,2742385,2742386,2742397,2742398,2742399,2742166,2742167,2742168,2742127,2742128,2742129,2742153,2742154,2742155,2742140,2742141,2742142,2741911,2741912,2741913,2110263,2110264,2002985,2002751,2002764,2002750,2002749,2002763,2002762,2002765,2001520,2106866,2105716,2002970,4048449,4171495,4294667,4136219,4211987,4269652,43531089,2005480,2005479,2005457,2005460,2005454,2005459,2005458,4165542,2005515,2002769,2105442,2105431,2105405,2105690,2105691,2105170,2105402,2104281,2104292,2104293,2105425,2105167,2104943,2104914,2105151,2105150,2105166,2105165,2105424,2105422,2105423,2105738,2105741,2104920,2104934,2104933,2105188,2105783,2105202,2105203,2105191,2105383,2105734,2105779,2105206,2105182,2105386,2105389,2105428,2105753,2104873,2104874,2104875,2104872,2104937,2104938,2105761,2105715,2105757,2105720,2105775,2105186,2105185,2105369,2105409,2105408,4071054,4240103,4223088,4215018,2001388,2103657,2103373,2105548,2105549,2105546,2105545,2105543,2105544,2105542,2105628,2103174,2103454,2103457,2103456,2103455,2103440,2103453,2103452,2103441,2103439,2103438,2103437,2002986,2003410,2003423,2003411,2003424,2003422,2003425,2003403,2003405,2003404,2003406,2002770,2002990,2002909,2003442,2006415,2001517,2005812,2005813,2005723,2005792,2001414,2000167,2001519,2001524,2002922,2003249,2003251,2000836,2001340,2003524,2003211,2005139,2005154,2005155,2005152,2005159,2005156,2005153,2005141,2005158,2005157,2005140,2003983,2003970,2002971,2004263,2004248,2004249,2004264,2003003,2002987,2001521,2003966,2003429,2004243,2003391,2004246,2006413,2108859,2108858,2108860,2103654,2103851,2103863,2103656,2103862,2103655,2104441,2104439,2104440,2105011,2104121,2104120,2105269,2105268,2105562,2105550,2105551,4145879,4098879,2103419,2103432,2103421,2103420,2103433,2103436,2103435,2103434,2104793,2104792,4216307,2004883,2105006,2109161,2110180,2103559,42742468,42742467,2105689,2104280,2105163,2104913,2105737,2105782,2105733,2105778,2105760,2105714,2105756,2105719,2105774,2105368,2001523,4211496,2105566,2106730,2106905,2103541,4163366,2103555,2103553,2103554,2101828,2109157,2109153,2109158,2109159,2109155,2109156,2109154,2109160,2109151,2109152,2109216,2104877,2105131,2110036,2110035,2110032,2110034,2110033,2110031,2110037,2110039,2110038,4144883,4138609,4137375,4142569,2104135,4146777,2110179,4096783,42732165,42732170,42732169,42732114,2103864,2103375,2103376,4251336,42735628,2104456,2105022,2104452,2103661,2104454,2103867,2104132,2103865,2103659,2105271,2104795,2104796,2104797,2105570,2105571,2103660,2105282,2105569,2105270,2104794,42732733,42732763,4262130,2742425,2778064,2742638,2742433,2742634,2742636,2742430,2742431,2742632,2742432,2742633,2742637,2742429,2742631,2742635,2742426,2742428,2742435,2742427,2742434,2742424,4034678,4150525,2103219,2103220,2005862,2005865,2005866,2005867,2005869,2005868,2005863,2005864,4053679,2005870,2103560,2752259,2752260,2752261,2752262,2752263,2752249,2752250,2752251,2752252,2752253,2747346,2747347,2747348,2747351,2747352,2747353,2742922,2742645,2747341,2747342,2747343,2752244,2752245,2752246,2752247,2752248,43016972,43016973,43016974,43016975,43016976,2752239,2752240,2752241,2752242,2752243,2747361,2747362,2747363,2746595,2746596,2746597,2752226,2752227,2752228,43016971,2747385,2747386,2747387,2746610,2746611,2746612,2746605,2746606,2746607,2746600,2746601,2746602,2747326,2747327,2747328,2742936,2752234,2752235,2752236,2752237,2752238,2775225,2775226,2775227,2775215,2775216,2775217,2747336,2747337,2747338,2752223,2752224,2752225,2742685,2742907,2742917,2742670,2742930,2742675,2742897,2775235,2775236,2775237,2747388,2747389,2747390,2742680,2752217,2752218,2752219,2742902,2747391,2747392,2747393,43016983,43016984,43016985,2752264,2752265,2752266,43016977,2752254,2752255,2752256,2752257,2752258,2746810,2746811,2746812,2742933,2752229,2752230,2752231,2752232,2752233,2775220,2775221,2775222,2775210,2775211,2775212,2747331,2747332,2747333,2752220,2752221,2752222,2742665,2742892,2742912,2742650,2742660,2742695,2742927,2742655,2742690,2775230,2775231,2775232,2747366,2747367,2747368,2746590,2746591,2746592,2739909,2739910,2739911,2742640,2747356,2747357,2747358,2103033,2778609,2743682,2743189,2742944,2743685,2778606,2743680,2743448,2779359,2743662,2743424,2779341,2743187,2742940,2743190,2742945,2778608,2743451,2779361,2743427,2779343,2742943,2769629,2769633,2769637,2765906,2765911,2765916,2766415,2766420,2766425,2765940,2766132,2766137,2766671,2766676,2766681,2766161,2766166,2766171,2766637,2766642,2766647,2766381,2766386,2766391,2766891,2766896,2766901,2769659,2769664,2765882,2769616,2769620,2769624,2765889,2765894,2765899,2766398,2766403,2766408,2765923,2765928,2765933,2766654,2766659,2766664,2766144,2766149,2766154,2766432,2766437,2766630,2766178,2766183,2766188,2766688,2766879,2766884,2769642,2769647,2769652,2743191,2742946,2743681,2743450,2743664,2743426,2743188,2742942,2778611,2743684,2743194,2742948,2778612,43016633,43016613,2779363,43016618,43016596,2779345,43016578,2778607,2743449,2779360,2743663,2743425,2779342,2742941,2778610,2778617,2779331,2743683,2779362,2779344,2743193,2742947,2743192,2103574,43531179,43531182,2005332,4093280,2106762,2106751,2106763,2106765,2106764,2106766,2106748,2106750,2106749,2103561,2103573,2103579,2103580,2101714,2111280,2107230,2783236,2783237,2783238,2783028,2783029,2783030,2744192,2743719,2784384,2744206,2783020,2783021,2783022,2783012,2783013,2783014,2743955,2743985,2744187,2743940,2744200,2743945,2743975,2743950,2743980,2744203,2783016,2783017,2783018,2783008,2783009,2783010,2743935,2743970,2744182,2743724,2743930,2743965,2744197,2743925,2743960,2743714,2109505,2109504,2109493,2109496,2109495,2109500,2109499,2109490,2109489,2109488,2109487,2109494,2106863,2110739,2105348,2003407,2105347,2105346,2105345,2105344,2109498,2109497,2109502,2109501,2109492,2109491,2109510,2109509,2109508,2109507,2109506,2108507,2108508,2109486,2109485,2109484,2109483,2108501,2108503,2105123,2105671,2105670,40757002,40757068,40757015,40756938,40756891,40757063,1531672,2774102,1531671,1531669,1531670,42897909,42897911,42897910,2774106,43017849,43017851,43017850,1531668,1531666,1531667,2774103,2774105,2774104,2774559,2774563,2774560,2774562,2774561,2774569,2774573,2774570,2774572,2774571,2767703,2767706,2767901,2767913,2767916,2767919,2767931,2767934,2767937,1531679,2774097,1531678,1531676,1531677,42897906,42897908,42897907,2774101,43017846,43017848,43017847,1531675,1531673,1531674,2774098,2774100,2774099,2774368,2774558,2774369,2774371,2774370,2774564,2774568,2774565,2774567,2774566,2767694,2767697,2767700,2767904,2767907,2767910,2767922,2767925,2767928,2744211,2775078,2775069,2775072,2775075,2775077,2774875,2775071,2775074,2775079,2775070,2775073,2775076,2744229,2768705,2768712,2768907,2768709,2768716,2768911,2768704,2768711,2768906,2768706,2768713,2768908,2768707,2768714,2768909,2768708,2768715,2768910,2768913,2768710,2768717,2768912,2769427,2769434,2769441,2769431,2769438,2769445,2769426,2769433,2769440,2769428,2769435,2769442,2769429,2769436,2769443,2769430,2769437,2769444,2769447,2769432,2769439,2769446,2774837,2774828,2774831,2774834,2774836,2774827,2774830,2774833,2774838,2774829,2774832,2774835,2774861,2774852,2774855,2774858,2774860,2774851,2774854,2774857,2774862,2774853,2774856,2774859,2768937,2768944,2768951,2768941,2768948,2768955,2768936,2768943,2768950,2768938,2768945,2768952,2768939,2768946,2768953,2768940,2768947,2768954,2768957,2768942,2768949,2768956,2744219,2744225,2744227,2744216,2769666,2769669,2769672,2769665,2769668,2769671,2769674,2769667,2769670,2769673,43017785,43017778,43017781,43017784,43017777,43017780,43017783,43017776,43017779,43017782,2775344,2775335,2775338,2775341,2775343,2775334,2775337,2775340,2775345,2775336,2775339,2775342,2769163,2769166,2769169,2768968,2769165,2769168,2769171,2769164,2769167,2769170,2765566,2765587,2765572,2765579,2765586,2775102,2775093,2775096,2775099,2775101,2775092,2775095,2775098,2775103,2775094,2775097,2775100,2769459,2769462,2769465,2769458,2769461,2769464,2769467,2769460,2769463,2769466,2775126,2775117,2775120,2775123,2775125,2775116,2775119,2775122,2775127,2775118,2775121,2775124,2769195,2769202,2769209,2769199,2769206,2769213,2769194,2769201,2769208,2769196,2769203,2769210,2769197,2769204,2769211,2769198,2769205,2769212,2769215,2769200,2769207,2769214,2775368,2775359,2775362,2775365,2775367,2775358,2775361,2775364,2775369,2775360,2775363,2775366,2769686,2769689,2769692,2769685,2769688,2769691,2769694,2769687,2769690,2769693,2765610,2761836,2765616,2765623,2761835,2768661,2768668,2768675,2768665,2768672,2768679,2768660,2768667,2768674,2768662,2768669,2768676,2768663,2768670,2768677,2768664,2768671,2768678,2768681,2768666,2768673,2768680,2744217,2744223,2744218,2744224,2774873,2774864,2774867,2774870,2774872,2774863,2774866,2774869,2774874,2774865,2774868,2774871,2744228,2768683,2768690,2768697,2768687,2768694,2768701,2768682,2768689,2768696,2768684,2768691,2768698,2768685,2768692,2768699,2768686,2768693,2768700,2768703,2768688,2768695,2768702,2769217,2769224,2769419,2769221,2769416,2769423,2769216,2769223,2769418,2769218,2769225,2769420,2769219,2769414,2769421,2769220,2769415,2769422,2769425,2769222,2769417,2769424,2774825,2774816,2774819,2774822,2774824,2774815,2774818,2774821,2774826,2774817,2774820,2774823,2774849,2774840,2774843,2774846,2774848,2774839,2774842,2774845,2774850,2774841,2774844,2774847,2768915,2768922,2768929,2768919,2768926,2768933,2768914,2768921,2768928,2768916,2768923,2768930,2768917,2768924,2768931,2768918,2768925,2768932,2768935,2768920,2768927,2768934,2744215,2744222,2744226,2744212,2769469,2769472,2769475,2769468,2769471,2769474,2769477,2769470,2769473,2769476,43017775,43017768,43017771,43017774,43017767,43017770,43017773,43017766,43017769,43017772,2775332,2775129,2775326,2775329,2775331,2775128,2775325,2775328,2775333,2775130,2775327,2775330,2744214,2744221,2768959,2768962,2768965,2768958,2768961,2768964,2768967,2768960,2768963,2768966,2765346,2765565,2765352,2765359,2765564,2775090,2775081,2775084,2775087,2775089,2775080,2775083,2775086,2775091,2775082,2775085,2775088,2769449,2769452,2769455,2769448,2769451,2769454,2769457,2769450,2769453,2769456,2775114,2775105,2775108,2775111,2775113,2775104,2775107,2775110,2775115,2775106,2775109,2775112,2769173,2769180,2769187,2769177,2769184,2769191,2769172,2769179,2769186,2769174,2769181,2769188,2769175,2769182,2769189,2769176,2769183,2769190,2769193,2769178,2769185,2769192,2775356,2775347,2775350,2775353,2775355,2775346,2775349,2775352,2775357,2775348,2775351,2775354,2769676,2769679,2769682,2769675,2769678,2769681,2769684,2769677,2769680,2769683,2765588,2765609,2765594,2765601,2765608,2768452,2768459,2768466,2768456,2768463,2768657,2768451,2768458,2768465,2768453,2768460,2768467,2768454,2768461,2768468,2768455,2768462,2768656,2768659,2768457,2768464,2768658,2744213,2744220,2744210,2110265,2110267,2110266,2106768,2753382,2753383,2753384,2753385,2753386,2753387,2753388,2753389,2753966,2744456,2778687,2778688,2778689,2778690,2778691,2744233,2753378,2753379,2753380,2753381,2772928,2772930,2753394,2753395,2753396,2753397,43017217,2753504,2753505,2753176,2753177,2753368,2753369,2740662,2753965,2772946,2744460,2772952,2761021,2761022,2740668,2753374,2753375,2753376,2753377,43017215,2744249,2744450,2744454,2744243,2772950,2778682,2778683,2778684,2778685,2778686,2756439,2744245,2744446,2744247,2775371,2775372,2744448,2780477,2780478,2780479,2780480,2753402,2753403,2753404,2753405,2740660,2753964,2772945,2762127,2744458,2772951,2761019,2761020,2740666,2753370,2753371,2753372,2753373,2744241,2744444,2744452,2744235,2772949,2744239,2744442,2778677,2778678,2778679,2778680,2778681,2756437,2744237,2744440,2753398,2753399,2753400,2753401,43017218,2772931,2772932,2740664,2744231,2753390,2753391,2753392,2753393,43017216,2778898,2778899,43018211,43018212,43018213,43018214,43018215,2778900,2778901,2778902,2106770,2106769,2106889,2105567,2103658,2105563,2744742,2744743,2744744,2745227,2745228,2745229,2744999,2745000,2745001,2745012,2745013,2745203,2745214,2745215,2745216,2744986,2744987,2744988,2744755,2744756,2744757,2744973,2744974,2744975,2744960,2744961,2744962,2744729,2744730,2744731,4194172,2101719,2103577,2103578,2785411,2741728,2745480,2745244,2741926,2785408,2741726,2741696,2785648,2741714,2741678,2785628,2745478,2745241,2767216,2767221,2767226,2767754,2767759,2767764,2767256,2767261,2767266,2768022,2768218,2768223,2767487,2767492,2767497,2767982,2767987,2767992,2767714,2767719,2767724,2768253,2768258,2768263,2766980,2766985,2766990,2767000,2767005,2767206,2767734,2767739,2767744,2767236,2767241,2767246,2768002,2768007,2768012,2767467,2767472,2767477,2767962,2767967,2767972,2767507,2767512,2767517,2768233,2768238,2768243,2766960,2766965,2766970,2745481,2745245,2785410,2741698,2785650,2741680,2785630,2745243,2767215,2767220,2767225,2767753,2767758,2767763,2767255,2767260,2767265,2768021,2768217,2768222,2767486,2767491,2767496,2767981,2767986,2767991,2767713,2767718,2767723,2768252,2768257,2768262,2766979,2766984,2766989,2766999,2767004,2767205,2767733,2767738,2767743,2767235,2767240,2767245,2768001,2768006,2768011,2767466,2767471,2767476,2767773,2767966,2767971,2767506,2767511,2767516,2768232,2768237,2768242,2766959,2766964,2766969,2745482,2745246,2777656,2777623,2741727,2741697,2741715,2741679,2745479,2745242,2785413,2741730,2745485,2745248,2785414,43016554,43016544,2785652,43016549,43016528,2785632,43016854,2785409,2785649,2785629,2785412,2741729,2777657,2777665,2767258,2767263,2767459,2767489,2767494,2767499,2785651,2767716,2767721,2767726,2777624,2777632,2777640,2767238,2767243,2767248,2767469,2767474,2767479,2785631,2767509,2767514,2767519,2745484,2745247,2745483,2006360,4180733,4106397,2000080,2000081,2000079,2006358,2000082,2006336,2006338,2006339,2006337,2110248,4218886,4233420,4337611,4168529,4208113,4041351,2103374,4072416,2110318,2783766,2783769,2783768,2783771,2783767,2783770,2783549,2783552,2783551,2783554,2783550,2783553,2744469,2744471,2744470,2784636,2784638,2784637,2744722,2744724,2744723,2783537,2783540,2783539,2783542,2783538,2783541,2783525,2783528,2783527,2783530,2783526,2783529,2775882,2775881,2775883,2775886,2775889,2776369,2776371,2765975,2765978,2765981,2744710,2744712,2744711,2744499,2744501,2744500,2765993,2765996,2765999,2766201,2766204,2766207,2744698,2744700,2744699,2744704,2744706,2744705,2744716,2744718,2744717,2783531,2783534,2783533,2783536,2783532,2783535,2783519,2783522,2783521,2783524,2783520,2783523,2775871,2775870,2775872,2775875,2775878,2776368,2776370,2765966,2765969,2765972,2744493,2744495,2744494,2744475,2744477,2744476,2744487,2744489,2744488,2765984,2765987,2765990,2766192,2766195,2766198,2744481,2744483,2744482,2744463,2744465,2744464,2110177,4263480,2104112,2105564,2108485,4301336,2106890,2106891,2106830,2106822,2106807,42742516,42742518,42742517,2106808,42742507,42742505,42742506,2106702,2106709,2106691,2106704,42742510,2106689,2106703,2106706,2106707,2106705,42742509,42742508,4021531,2110175,2110176,2110178,4096461,2101713,2103576,46257445,2103575,43531648,40488851,2108856,2108855,4179719,4172438,2110499,2109346,2106964,2106965,2110658,2110657,2110656,4337138,2741982,2741983,2741984,2741973,2741974,2741975,2741979,2741980,2741981,2741967,2741968,2741969,2741970,2741971,2741972,2741964,2741965,2741966,2741976,2741977,2741978,2741961,2741962,2741963,2741958,2741959,2741960,4217180,4073700,4234536,2104918,2104917,2104861,2104860,2104936,2104935,2105718,2105717,2105370,2006433,2006419,2004231,2006421,2003427,2003428,2003402,2004244,2006417,2006412,2109145,2109524,4138738,2110181,2110184,2110182,2110183,2110185,2110189,2110192,2110190,2110191,2110193,2110188,2110186,2110187,2110666,2110665,2110670,2110669,2110674,2110675,2110673,2110672,2110671,2110668,2110667)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 9)
) C


-- End Procedure Occurrence Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

select 0 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_0
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 9)
) C

WHERE (C.procedure_date >= DATEFROMPARTS(2008, 1, 1) and C.procedure_date <= DATEFROMPARTS(2020, 1, 1))
-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 1 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_1
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo
JOIN #Codesets cs on (vo.visit_concept_id = cs.concept_id and cs.codeset_id = 7)
) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,2,P.START_DATE) AND A.END_DATE >= DATEADD(day,-2,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 2 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_2
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-30,P.START_DATE) AND A.START_DATE <= DATEADD(day,30,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 8)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.END_DATE >= DATEADD(day,-30,P.START_DATE) AND A.END_DATE <= DATEADD(day,30,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 3 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_3
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Demographic Criteria
SELECT 0 as index_id, e.person_id, e.event_id
FROM #qualified_events E
JOIN @cdm_database_schema.PERSON P ON P.PERSON_ID = E.PERSON_ID
WHERE (YEAR(E.start_date) - P.year_of_birth >= 18 and YEAR(E.start_date) - P.year_of_birth <= 89)
GROUP BY e.person_id, e.event_id
-- End Demographic Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 4 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_4
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo

) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,-730,P.START_DATE) AND A.START_DATE <= DATEADD(day,-30,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 2
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Visit Occurrence Criteria
select C.person_id, C.visit_occurrence_id as event_id, C.visit_start_date as start_date, C.visit_end_date as end_date,
       C.visit_occurrence_id, C.visit_start_date as sort_date
from 
(
  select vo.* 
  FROM @cdm_database_schema.VISIT_OCCURRENCE vo

) C


-- End Visit Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,30,P.START_DATE) AND A.START_DATE <= DATEADD(day,730,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 2
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 2
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 5 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_5
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Procedure Occurrence Criteria
select C.person_id, C.procedure_occurrence_id as event_id, C.procedure_date as start_date, DATEADD(d,1,C.procedure_date) as END_DATE,
       C.visit_occurrence_id, C.procedure_date as sort_date
from 
(
  select po.* 
  FROM @cdm_database_schema.PROCEDURE_OCCURRENCE po
JOIN #Codesets cs on (po.procedure_concept_id = cs.concept_id and cs.codeset_id = 9)
) C


-- End Procedure Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,61,P.START_DATE) AND A.START_DATE <= DATEADD(day,213,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 6 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_6
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, p.person_id, p.event_id
from #qualified_events p
LEFT JOIN (
SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Death Criteria
select C.person_id, C.person_id as event_id, C.death_date as start_date, DATEADD(d,1,C.death_date) as end_date,
  CAST(NULL as bigint) as visit_occurrence_id, C.death_date as sort_date
from 
(
  select d.*
  FROM @cdm_database_schema.DEATH d

) C


-- End Death Criteria


) A on A.person_id = P.person_id  AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,365,P.START_DATE) ) cc on p.person_id = cc.person_id and p.event_id = cc.event_id
GROUP BY p.person_id, p.event_id
HAVING COUNT(cc.event_id) = 0
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

select 7 as inclusion_rule_id, person_id, event_id
INTO #Inclusion_7
FROM 
(
  select pe.person_id, pe.event_id
  FROM #qualified_events pe
  
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM #qualified_events E
  INNER JOIN
  (
    -- Begin Correlated Criteria
select 0 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
  C.visit_occurrence_id, C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets cs on (co.condition_concept_id = cs.concept_id and cs.codeset_id = 3)
) C


-- End Condition Occurrence Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,180,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 1 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.visit_occurrence_id,C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets cs on (de.drug_concept_id = cs.concept_id and cs.codeset_id = 4)
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,180,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

UNION ALL
-- Begin Correlated Criteria
select 2 as index_id, cc.person_id, cc.event_id
from (SELECT p.person_id, p.event_id 
FROM #qualified_events P
JOIN (
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.visit_occurrence_id, C.measurement_date as sort_date
from 
(
  select m.* 
  FROM @cdm_database_schema.MEASUREMENT m
JOIN #Codesets cs on (m.measurement_concept_id = cs.concept_id and cs.codeset_id = 5)
) C

WHERE (C.value_as_number >= 6.5000 and C.value_as_number <= 20.0000)
AND C.unit_concept_id in (8554)
-- End Measurement Criteria

) A on A.person_id = P.person_id  AND A.START_DATE <= DATEADD(day,180,P.START_DATE) ) cc 
GROUP BY cc.person_id, cc.event_id
HAVING COUNT(cc.event_id) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) > 0
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id AND AC.event_id = pe.event_id
) Results
;

SELECT inclusion_rule_id, person_id, event_id
INTO #inclusion_events
FROM (select inclusion_rule_id, person_id, event_id from #Inclusion_0
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_1
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_2
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_3
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_4
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_5
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_6
UNION ALL
select inclusion_rule_id, person_id, event_id from #Inclusion_7) I;
TRUNCATE TABLE #Inclusion_0;
DROP TABLE #Inclusion_0;

TRUNCATE TABLE #Inclusion_1;
DROP TABLE #Inclusion_1;

TRUNCATE TABLE #Inclusion_2;
DROP TABLE #Inclusion_2;

TRUNCATE TABLE #Inclusion_3;
DROP TABLE #Inclusion_3;

TRUNCATE TABLE #Inclusion_4;
DROP TABLE #Inclusion_4;

TRUNCATE TABLE #Inclusion_5;
DROP TABLE #Inclusion_5;

TRUNCATE TABLE #Inclusion_6;
DROP TABLE #Inclusion_6;

TRUNCATE TABLE #Inclusion_7;
DROP TABLE #Inclusion_7;


with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

  -- the matching group with all bits set ( POWER(2,# of inclusion rules) - 1 = inclusion_rule_mask
  WHERE (MG.inclusion_rule_mask = POWER(cast(2 as bigint),8)-1)

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results
WHERE Results.ordinal = 1
;

-- date offset strategy

select event_id, person_id, 
  case when DATEADD(day,365,start_date) > op_end_date then op_end_date else DATEADD(day,365,start_date) end as end_date
INTO #strategy_ends
from #included_events;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 0, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,0,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;




TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;